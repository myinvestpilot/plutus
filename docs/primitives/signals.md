# ä¿¡å·åŸè¯­å‚è€ƒæŒ‡å—

ä¿¡å·åŸè¯­(Signal Primitives)æ˜¯ç”¨äºç”Ÿæˆäº¤æ˜“ä¿¡å·çš„ç»„ä»¶ï¼Œå®ƒä»¬æ¥æ”¶ä¸€ä¸ªæˆ–å¤šä¸ªæ—¶é—´åºåˆ—ä½œä¸ºè¾“å…¥ï¼Œå¹¶è¾“å‡ºå¸ƒå°”å‹æ—¶é—´åºåˆ—(true/false)ã€‚è¿™äº›ç»„ä»¶å¯ä»¥ç»„åˆæˆå¤æ‚çš„äº¤æ˜“æ¡ä»¶ã€‚

## ä¿¡å·åŸè¯­åŸºç¡€

æ‰€æœ‰ä¿¡å·åŸè¯­éƒ½å®ç°äº†`evaluate`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¥æ”¶è¾“å…¥æ—¶é—´åºåˆ—å¹¶è¿”å›å¸ƒå°”ç»“æœã€‚ä¿¡å·åŸè¯­å¯ä»¥ï¼š

1. è¯„ä¼°å•ä¸ªæ—¶é—´ç‚¹(è¿”å›å•ä¸ªå¸ƒå°”å€¼)
2. è¯„ä¼°æ•´ä¸ªæ—¶é—´åºåˆ—(è¿”å›å¸ƒå°”å‹Series)

## å¯ç”¨ä¿¡å·åŸè¯­

### æ¯”è¾ƒç±»ä¿¡å·

> **âš ï¸ é‡è¦è­¦å‘Šï¼šè¾“å…¥é¡ºåºè‡³å…³é‡è¦**
>
> å¯¹äºæ‰€æœ‰æ¯”è¾ƒç±»ä¿¡å·ï¼ˆå°¤å…¶æ˜¯LessThanå’ŒGreaterThanï¼‰ï¼Œè¾“å…¥å‚æ•°çš„é¡ºåºä¼šç›´æ¥å½±å“æ¯”è¾ƒç»“æœã€‚
> å½“æ¶‰åŠå¸¸é‡ä¸å˜é‡çš„æ¯”è¾ƒæ—¶ï¼Œ**å¿…é¡»å°†å¸¸é‡æ”¾åœ¨å·¦ä¾§ï¼Œå˜é‡æ”¾åœ¨å³ä¾§**ï¼Œä»¥ç¡®ä¿æ‰§è¡Œé¢„æœŸçš„æ¯”è¾ƒã€‚
>
> é”™è¯¯ç¤ºä¾‹ï¼ˆå¸¸è§é”™è¯¯ï¼ï¼‰ï¼š
> ```json
> // æœ¬æ„æ˜¯ rsi < 70ï¼Œä½†å®é™…æ‰§è¡Œçš„æ˜¯ 70 < rsi
> {
>   "type": "LessThan",
>   "inputs": [
>     { "ref": "rsi" },
>     { "type": "Constant", "value": 70 }
>   ]
> }
> ```
>
> æ­£ç¡®ç¤ºä¾‹ï¼š
> ```json
> // æ­£ç¡®æ‰§è¡Œ rsi < 70
> {
>   "type": "LessThan",
>   "inputs": [
>     { "type": "Constant", "value": 70 },
>     { "ref": "rsi" }
>   ]
> }
> ```

#### GreaterThan å’Œ LessThan (æ›¿ä»£ Comparison)

æ¨èä½¿ç”¨ GreaterThan å’Œ LessThan æ›¿ä»£é€šç”¨çš„ Comparisonï¼Œå®ƒä»¬æä¾›æ›´æ˜ç¡®çš„è¯­ä¹‰å’Œæ›´å¥½çš„æ€§èƒ½ã€‚

```json
{
  "id": "price_above_ma",
  "type": "GreaterThan",
  "epsilon": 0.01,
  "inputs": [
    { "column": "Close" },
    { "ref": "ma_indicator" }
  ]
}
```

**å‚æ•°**:
- `epsilon`: ç”¨äºå¤„ç†æµ®ç‚¹æ¯”è¾ƒç²¾åº¦é—®é¢˜çš„å°å€¼(é»˜è®¤: 0)

**æ³¨æ„äº‹é¡¹**:
- æ¯”è¾ƒä¸¤ä¸ªæ—¶é—´åºåˆ—æ—¶ï¼Œä¼šä½¿ç”¨epsilonå€¼ä½œä¸ºç²¾åº¦ç¼“å†²
- è¾“å…¥é¡ºåºè‡³å…³é‡è¦ï¼Œè¯·å‚è€ƒä¸‹é¢çš„ GreaterThan å’Œ LessThan éƒ¨åˆ†

#### GreaterThan (å¤§äº)

æ£€æŸ¥ç¬¬ä¸€ä¸ªè¾“å…¥æ˜¯å¦å¤§äºç¬¬äºŒä¸ªè¾“å…¥ã€‚**è¾“å…¥é¡ºåºè‡³å…³é‡è¦**ï¼

```json
{
  "id": "price_gt_ma",
  "type": "GreaterThan",
  "epsilon": 0.01,
  "inputs": [
    { "column": "Close" },     // è¦æ£€æŸ¥çš„å€¼æ”¾ç¬¬ä¸€ä½
    { "ref": "ma_indicator" }  // ä¸ä¹‹æ¯”è¾ƒçš„å€¼æ”¾ç¬¬äºŒä½
  ]
}
```

**å¸¸é‡æ¯”è¾ƒçš„æ­£ç¡®å†™æ³•**ï¼š

```json
{
  "id": "rsi_overbought",
  "type": "GreaterThan",
  "epsilon": 0.5,
  "inputs": [
    { "ref": "rsi_indicator" },            // å˜é‡æ”¾ç¬¬ä¸€ä½
    { "ref": "upper_threshold" }           // å¼•ç”¨å¸¸é‡æŒ‡æ ‡è€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨value
  ]
}
```

**å‚æ•°**:

- `epsilon`: æµ®ç‚¹æ•°æ¯”è¾ƒç²¾åº¦å‚æ•°ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä¸º0ï¼‰ã€‚å½“æ¯”è¾ƒ a > b æ—¶ï¼Œå®é™…æ¯”è¾ƒä¸º a > (b + epsilon)ã€‚
  - ä¾‹å¦‚ï¼šå½“é˜ˆå€¼ä¸º70ï¼Œepsilonä¸º0.01æ—¶ï¼Œåªæœ‰å€¼å¤§äº70.01æ‰ä¼šè¿”å›true
  - é€‚ç”¨äºå¤„ç†è¾¹ç•Œæ¡ä»¶å’Œæµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜

**æ³¨æ„äº‹é¡¹**ï¼š

- æ— è®ºæ˜¯å¦ä½¿ç”¨ epsilonï¼Œè¾“å…¥çš„é¡ºåºéƒ½æ˜¯å†³å®šæ€§çš„
- å¯¹äº `GreaterThan(a, b)`ï¼Œæ‰§è¡Œçš„æ˜¯ `a > (b + epsilon)`
- æ¨èä½¿ç”¨å¸¸é‡æŒ‡æ ‡ï¼ˆå¦‚ `upper_threshold`ï¼‰è€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨ `value` å±æ€§

#### LessThan (å°äº)

æ£€æŸ¥ç¬¬ä¸€ä¸ªè¾“å…¥æ˜¯å¦å°äºç¬¬äºŒä¸ªè¾“å…¥ã€‚**è¾“å…¥é¡ºåºè‡³å…³é‡è¦**ï¼

```json
{
  "id": "price_lt_ma",
  "type": "LessThan",
  "epsilon": 0.01,
  "inputs": [
    { "column": "Close" },     // è¦æ£€æŸ¥çš„å€¼æ”¾ç¬¬ä¸€ä½
    { "ref": "ma_indicator" }  // ä¸ä¹‹æ¯”è¾ƒçš„å€¼æ”¾ç¬¬äºŒä½
  ]
}
```

**å¸¸é‡æ¯”è¾ƒçš„æ­£ç¡®å†™æ³•**ï¼š

```json
{
  "id": "rsi_not_overbought",
  "type": "LessThan",
  "epsilon": 0.5,
  "inputs": [
    { "ref": "rsi_indicator" },            // å˜é‡æ”¾ç¬¬ä¸€ä½
    { "ref": "upper_threshold" }           // å¼•ç”¨å¸¸é‡æŒ‡æ ‡è€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨value
  ]
}
```

**å‚æ•°**:

- `epsilon`: æµ®ç‚¹æ•°æ¯”è¾ƒç²¾åº¦å‚æ•°ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä¸º0ï¼‰ã€‚å½“æ¯”è¾ƒ a < b æ—¶ï¼Œå®é™…æ¯”è¾ƒä¸º a < (b - epsilon)ã€‚
  - ä¾‹å¦‚ï¼šå½“é˜ˆå€¼ä¸º70ï¼Œepsilonä¸º0.01æ—¶ï¼Œåªæœ‰å€¼å°äº69.99æ‰ä¼šè¿”å›true
  - é€‚ç”¨äºå¤„ç†RSIç­‰æŒ‡æ ‡çš„è¾¹ç•Œæ¡ä»¶å’Œæµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜

**æ³¨æ„äº‹é¡¹**ï¼š

- æ— è®ºæ˜¯å¦ä½¿ç”¨ epsilonï¼Œè¾“å…¥çš„é¡ºåºéƒ½æ˜¯å†³å®šæ€§çš„
- å¯¹äº `LessThan(a, b)`ï¼Œæ‰§è¡Œçš„æ˜¯ `a < (b - epsilon)`
- æ¨èä½¿ç”¨å¸¸é‡æŒ‡æ ‡ï¼ˆå¦‚ `lower_threshold`ï¼‰è€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨ `value` å±æ€§

#### InRange (åœ¨èŒƒå›´å†…)

æ£€æŸ¥è¾“å…¥å€¼æ˜¯å¦åœ¨æŒ‡å®šèŒƒå›´å†…ã€‚

```json
{
  "id": "rsi_neutral",
  "type": "InRange",
  "params": {
    "lower_inclusive": true,
    "upper_inclusive": true
  },
  "inputs": [
    { "ref": "rsi_indicator" },
    { "ref": "lower_bound" },
    { "ref": "upper_bound" }
  ]
}
```

**å‚æ•°**:

- `lower_inclusive`: æ˜¯å¦åŒ…å«ä¸‹ç•Œ(é»˜è®¤: true)
- `upper_inclusive`: æ˜¯å¦åŒ…å«ä¸Šç•Œ(é»˜è®¤: true)

**æ³¨æ„äº‹é¡¹**:

- éœ€è¦ä¸‰ä¸ªè¾“å…¥: è¯„ä¼°å€¼, ä¸‹ç•Œ, ä¸Šç•Œ
- é€‚åˆæ£€æµ‹æŒ‡æ ‡æ˜¯å¦åœ¨ç‰¹å®šåŒºé—´å†…(å¦‚RSIåœ¨30-70ä¹‹é—´)

### äº¤å‰ç±»ä¿¡å·

#### Crossover (ä¸Šç©¿)

æ£€æµ‹ç¬¬ä¸€ä¸ªè¾“å…¥æ˜¯å¦å‘ä¸Šç©¿è¶Šç¬¬äºŒä¸ªè¾“å…¥ã€‚

```json
{
  "id": "price_cross_above_ma",
  "type": "Crossover",
  "params": { "mode": "simple" },
  "inputs": [
    { "column": "Close" },
    { "ref": "ma_indicator" }
  ]
}
```

**å‚æ•°**:

- `mode`: äº¤å‰æ£€æµ‹æ¨¡å¼ï¼Œå¯é€‰å€¼:
  - `simple`: ç®€å•äº¤å‰æ£€æµ‹ï¼ˆé»˜è®¤ï¼‰
  - `confirmed`: è¦æ±‚ç¡®è®¤ï¼ˆè¿ç»­ä¸¤ä¸ªå‘¨æœŸï¼‰

**æ³¨æ„äº‹é¡¹**:

- åªåœ¨å®é™…å‘ç”Ÿç©¿è¶Šçš„é‚£ä¸€ä¸ªæ—¶é—´ç‚¹è¿”å›true
- ç©¿è¶Šåçš„åç»­æ—¶é—´ç‚¹è¿”å›falseï¼Œç›´åˆ°å‘ç”Ÿæ–°çš„ç©¿è¶Š
- é€‚åˆç”¨ä½œä¹°å…¥/å–å‡ºè§¦å‘ä¿¡å·

#### Crossunder (ä¸‹ç©¿)

æ£€æµ‹ç¬¬ä¸€ä¸ªè¾“å…¥æ˜¯å¦å‘ä¸‹ç©¿è¶Šç¬¬äºŒä¸ªè¾“å…¥ã€‚

```json
{
  "id": "price_cross_below_ma",
  "type": "Crossunder",
  "params": { "mode": "simple" },
  "inputs": [
    { "column": "Close" },
    { "ref": "ma_indicator" }
  ]
}
```

**å‚æ•°**:

- `mode`: äº¤å‰æ£€æµ‹æ¨¡å¼ï¼Œå¯é€‰å€¼:
  - `simple`: ç®€å•äº¤å‰æ£€æµ‹ï¼ˆé»˜è®¤ï¼‰
  - `confirmed`: è¦æ±‚ç¡®è®¤ï¼ˆè¿ç»­ä¸¤ä¸ªå‘¨æœŸï¼‰

**æ³¨æ„äº‹é¡¹**:

- åªåœ¨å®é™…å‘ç”Ÿç©¿è¶Šçš„é‚£ä¸€ä¸ªæ—¶é—´ç‚¹è¿”å›true
- ç©¿è¶Šåçš„åç»­æ—¶é—´ç‚¹è¿”å›falseï¼Œç›´åˆ°å‘ç”Ÿæ–°çš„ç©¿è¶Š
- é€‚åˆç”¨ä½œä¹°å…¥/å–å‡ºè§¦å‘ä¿¡å·

### é€»è¾‘è¿ç®—ç¬¦ç±»

#### And (é€»è¾‘ä¸)

è¦æ±‚æ‰€æœ‰è¾“å…¥ä¿¡å·åŒæ—¶ä¸ºtrueã€‚æ”¯æŒåµŒå¥—ä¿¡å·å’Œå†…è”å¸¸é‡ã€‚

**åŸºæœ¬ç”¨æ³•**ï¼š
```json
{
  "id": "buy_condition",
  "type": "And",
  "inputs": [
    { "ref": "price_above_ma" },
    { "ref": "rsi_oversold" }
  ]
}
```

**åµŒå¥—ä¿¡å·ç¤ºä¾‹**ï¼š
```json
{
  "id": "buy_condition_core",
  "type": "And",
  "inputs": [
    { "ref": "macd_cross_signal" },
    {
      "type": "GreaterThan",
      "inputs": [
        { "column": "Volume" },
        { "ref": "volume_ma" }
      ],
      "params": {
        "threshold": 1.5
      }
    }
  ]
}
```
**å†…è”å¸¸é‡æ”¯æŒ**ï¼š
```json
{
  "id": "enhanced_buy",
  "type": "And", 
  "inputs": [
    { "ref": "buy_condition_core" },
    {
      "type": "LessThan",
      "inputs": [
        { "ref": "volume_ratio" },
        { "type": "Constant", "value": 3 }
      ]
    }
  ]
}
```

#### Or (é€»è¾‘æˆ–)

å½“ä»»ä¸€è¾“å…¥ä¿¡å·ä¸ºtrueæ—¶è¿”å›trueã€‚

```json
{
  "id": "sell_condition",
  "type": "Or",
  "inputs": [
    { "ref": "stop_loss_hit" },
    { "ref": "take_profit_hit" }
  ]
}
```

#### Not (é€»è¾‘é)

å¯¹è¾“å…¥ä¿¡å·å–åã€‚

```json
{
  "id": "not_overbought",
  "type": "Not",
  "inputs": [
    { "ref": "rsi_overbought" }
  ]
}
```

**é€»è¾‘è¿ç®—ç¬¦æ–°ç‰¹æ€§**ï¼š
1. **åµŒå¥—ä¿¡å·æ”¯æŒ**: And/Orå¯ä»¥æ¥å—åµŒå¥—çš„ä¿¡å·å®šä¹‰ä½œä¸ºè¾“å…¥
2. **å†…è”å¸¸é‡**: åµŒå¥—ä¿¡å·ä¸­æ”¯æŒ `{"type": "Constant", "value": N}` æ ¼å¼
3. **çµæ´»ç»„åˆ**: å¯ä»¥æ··åˆä½¿ç”¨ä¿¡å·å¼•ç”¨å’ŒåµŒå¥—å®šä¹‰

**æ³¨æ„äº‹é¡¹**:

- å¢å¼ºäº†NaNå¤„ç†é€»è¾‘
- é€‚åˆéœ€è¦æ’é™¤ç‰¹å®šæ¡ä»¶çš„åœºæ™¯
- åµŒå¥—ä¿¡å·ä¼šè‡ªåŠ¨è¯„ä¼°ï¼Œæ— éœ€é¢„å…ˆå®šä¹‰ID

### æ¨¡å¼è¯†åˆ«ç±»

#### Streak (è¿ç»­æ¨¡å¼)

æ£€æµ‹è¿ç»­æ»¡è¶³æ¡ä»¶çš„æ¨¡å¼ã€‚

```json
{
  "id": "consecutive_up_days",
  "type": "Streak",
  "params": {
    "condition": "true",
    "min_length": 3,
    "max_length": 5
  },
  "inputs": [
    { "ref": "daily_gain" }
  ]
}
```

**å‚æ•°**:

- `condition`: åŒ¹é…æ¡ä»¶("true"æˆ–"false")
- `min_length`: æœ€å°è¿ç»­é•¿åº¦
- `max_length`: æœ€å¤§è¿ç»­é•¿åº¦(å¯é€‰)

**æ³¨æ„äº‹é¡¹**:

- å¯ç”¨äºæ£€æµ‹è¿ç»­ä¸Šæ¶¨/ä¸‹è·Œæˆ–å…¶ä»–æŒç»­æ¨¡å¼
- å¦‚æœè®¾ç½®äº†`max_length`ï¼Œè¶…è¿‡è¯¥é•¿åº¦å°†è¿”å›false
- æ”¯æŒå¤šç§åŒ¹é…ç±»å‹å’Œé•¿åº¦é™åˆ¶

### æ•°å­¦è¿ç®—ç±»


> **ğŸ†• æ–°åŠŸèƒ½ï¼šçº¯æ•°å­¦è¿ç®—æ¨¡å¼**
>
> æ•°å­¦è¿ç®—ç±»ä¿¡å·ç°åœ¨æ”¯æŒä¸¤ç§å·¥ä½œæ¨¡å¼ï¼š
> 1. **æ¯”è¾ƒæ¨¡å¼**ï¼ˆé»˜è®¤ï¼‰ï¼šæ‰§è¡Œæ•°å­¦è¿ç®—åä¸é˜ˆå€¼æ¯”è¾ƒï¼Œè¿”å›å¸ƒå°”ç»“æœ
> 2. **çº¯æ•°å­¦æ¨¡å¼**ï¼šè®¾ç½® `return_calculation=true` æ—¶ï¼Œç›´æ¥è¿”å›æ•°å­¦è¿ç®—ç»“æœ
#### PercentChange (ç™¾åˆ†æ¯”å˜åŒ–)

è®¡ç®—æ—¶é—´åºåˆ—çš„ç™¾åˆ†æ¯”å˜åŒ–ï¼Œå¹¶ä¸é˜ˆå€¼æˆ–å¦ä¸€æ—¶é—´åºåˆ—æ¯”è¾ƒã€‚

```json
{
  "id": "price_up_5percent",
  "type": "PercentChange",
  "params": {
    "period": 5,
    "threshold": 5.0,
    "comparison": "greater"
  },
  "inputs": [
    { "column": "Close" }
  ]
}
```

**å‚æ•°**:

- `period`: è®¡ç®—å˜åŒ–çš„å‘¨æœŸ(é»˜è®¤: 1)
- `threshold`: æ¯”è¾ƒé˜ˆå€¼(å¯é€‰)
- `comparison`: æ¯”è¾ƒç±»å‹(é»˜è®¤: "greater")

**æ³¨æ„äº‹é¡¹**:

- å¯ä¸é˜ˆå€¼æ¯”è¾ƒæˆ–ä¸å¦ä¸€æ—¶é—´åºåˆ—æ¯”è¾ƒ
- é€‚åˆæ£€æµ‹ä»·æ ¼åŠ¨é‡æˆ–å¤§å¹…æ³¢åŠ¨

#### Add (åŠ æ³•)

å°†ä¸¤ä¸ªæˆ–å¤šä¸ªæ—¶é—´åºåˆ—ç›¸åŠ ã€‚æ”¯æŒæ¯”è¾ƒæ¨¡å¼å’Œçº¯æ•°å­¦è¿ç®—æ¨¡å¼ã€‚

**æ¯”è¾ƒæ¨¡å¼ç¤ºä¾‹**ï¼ˆé»˜è®¤è¡Œä¸ºï¼‰ï¼š
```json
{
  "id": "combined_gt_threshold",
  "type": "Add",
  "params": {
    "threshold": 100,
    "comparison": "greater"
  },
  "inputs": [
    { "ref": "indicator1" },
    { "ref": "indicator2" }
  ]
}
```

**çº¯æ•°å­¦è¿ç®—æ¨¡å¼ç¤ºä¾‹**ï¼š
```json
{
  "id": "combined_indicator",
  "type": "Add",
  "params": {
    "return_calculation": true
  },
  "inputs": [
    { "ref": "indicator1" },
    { "ref": "indicator2" },
    { "ref": "indicator3" }
  ]
}
```
**å‚æ•°**:
- `return_calculation`: æ˜¯å¦è¿”å›è®¡ç®—ç»“æœè€Œéæ¯”è¾ƒç»“æœï¼ˆé»˜è®¤: falseï¼‰
- `threshold`: æ¯”è¾ƒé˜ˆå€¼ï¼ˆä»…åœ¨æ¯”è¾ƒæ¨¡å¼ä¸‹ä½¿ç”¨ï¼‰
- `comparison`: æ¯”è¾ƒç±»å‹ï¼ˆä»…åœ¨æ¯”è¾ƒæ¨¡å¼ä¸‹ä½¿ç”¨ï¼Œé»˜è®¤: "greater"ï¼‰
- `absolute`: æ˜¯å¦å¯¹ç»“æœå–ç»å¯¹å€¼ï¼ˆé»˜è®¤: falseï¼‰
**å†…è”å¸¸é‡æ”¯æŒ**ï¼š
```json
{
  "id": "indicator_plus_constant",
  "type": "Add",
  "params": {
    "return_calculation": true
  },
  "inputs": [
    { "ref": "base_indicator" },
    { "type": "Constant", "value": 10 }
  ]
}
```
#### Subtract (å‡æ³•)

ä»ç¬¬ä¸€ä¸ªæ—¶é—´åºåˆ—ä¸­å‡å»ç¬¬äºŒä¸ªåŠåç»­æ—¶é—´åºåˆ—ï¼ˆæŒ‰ä»å·¦åˆ°å³é¡ºåºï¼‰ã€‚

**çº¯æ•°å­¦è¿ç®—ç¤ºä¾‹**ï¼š
```json
{
  "id": "indicator_difference",
  "type": "Subtract",
  "params": {
    "return_calculation": true
  },
  "inputs": [
    { "ref": "indicator1" },
    { "ref": "indicator2" }
  ]
}
```

**å¤šæ“ä½œæ•°ç¤ºä¾‹**ï¼ˆå·¦åˆ°å³è®¡ç®—ï¼š(a - b) - cï¼‰ï¼š
```json
{
  "id": "sequential_subtract",
  "type": "Subtract",
  "params": {
    "return_calculation": true
  },
  "inputs": [
    { "ref": "base_value" },
    { "ref": "adjustment1" },
    { "type": "Constant", "value": 5 }
  ]
}
```
#### Multiply (ä¹˜æ³•)

å°†ä¸¤ä¸ªæˆ–å¤šä¸ªæ—¶é—´åºåˆ—ç›¸ä¹˜ï¼ˆæ”¯æŒå¤šæ“ä½œæ•°ï¼‰ã€‚

**çº¯æ•°å­¦è¿ç®—ç¤ºä¾‹**ï¼š
```json
{
  "id": "weighted_indicator",
  "type": "Multiply",
  "params": {
    "return_calculation": true
  },
  "inputs": [
    { "ref": "indicator" },
    { "ref": "weight" }
  ]
}
```

**å¤šæ“ä½œæ•°ä¹˜æ³•ç¤ºä¾‹**ï¼š
```json
{
  "id": "signal_strength",
  "type": "Multiply",
  "params": {
    "return_calculation": true
  },
  "inputs": [
    { "ref": "macd_atr_ratio" },
    { "ref": "ma_close_ratio" },
    { "type": "Constant", "value": 1.0 }
  ]
}
```
#### Divide (é™¤æ³•)

å°†ç¬¬ä¸€ä¸ªæ—¶é—´åºåˆ—é™¤ä»¥ç¬¬äºŒä¸ªåŠåç»­æ—¶é—´åºåˆ—ï¼ˆæŒ‰ä»å·¦åˆ°å³é¡ºåºï¼‰ã€‚

**çº¯æ•°å­¦è¿ç®—ç¤ºä¾‹**ï¼š
```json
{
  "id": "indicator_ratio",
  "type": "Divide",
  "params": {
    "return_calculation": true
  },
  "inputs": [
    { "ref": "indicator1" },
    { "ref": "indicator2" }
  ]
}
```

**å¤šæ“ä½œæ•°ç¤ºä¾‹**ï¼ˆå·¦åˆ°å³è®¡ç®—ï¼š(a / b) / cï¼‰ï¼š
```json
{
  "id": "normalized_ratio",
  "type": "Divide",
  "params": {
    "return_calculation": true
  },
  "inputs": [
    { "column": "Volume" },
    { "ref": "volume_ma" },
    { "type": "Constant", "value": 1000 }
  ]
}
```
**æ•°å­¦è¿ç®—ç±»é€šç”¨å‚æ•°**ï¼š
- `return_calculation`: æ˜¯å¦è¿”å›çº¯æ•°å­¦è®¡ç®—ç»“æœï¼ˆé»˜è®¤: falseï¼‰
  - `true`: è¿”å›æ•°å€¼ç»“æœï¼Œæ”¯æŒå¤šæ“ä½œæ•°æŒ‰ä»å·¦åˆ°å³è®¡ç®—
  - `false`: æ‰§è¡Œè¿ç®—åä¸é˜ˆå€¼æ¯”è¾ƒï¼Œè¿”å›å¸ƒå°”ç»“æœ
- `threshold`: æ¯”è¾ƒé˜ˆå€¼ï¼ˆä»…åœ¨æ¯”è¾ƒæ¨¡å¼ä¸‹ç”Ÿæ•ˆï¼‰
- `comparison`: æ¯”è¾ƒç±»å‹ï¼ˆ"greater", "less", "equal"ç­‰ï¼Œä»…åœ¨æ¯”è¾ƒæ¨¡å¼ä¸‹ç”Ÿæ•ˆï¼‰
- `absolute`: æ˜¯å¦å¯¹è¿ç®—ç»“æœå–ç»å¯¹å€¼ï¼ˆé»˜è®¤: falseï¼‰
**é‡è¦ç‰¹æ€§**ï¼š
1. **å‘åå…¼å®¹**: é»˜è®¤è¡Œä¸ºä¿æŒä¸å˜ï¼Œç°æœ‰é…ç½®æ— éœ€ä¿®æ”¹
2. **å¤šæ“ä½œæ•°æ”¯æŒ**: çº¯æ•°å­¦æ¨¡å¼æ”¯æŒ2ä¸ªä»¥ä¸Šè¾“å…¥ï¼ŒæŒ‰ä»å·¦åˆ°å³é¡ºåºè®¡ç®—
3. **å†…è”å¸¸é‡**: æ”¯æŒ `{"type": "Constant", "value": N}` æ ¼å¼çš„å†…è”å¸¸é‡
4. **é™¤é›¶å¤„ç†**: Divideæ“ä½œè‡ªåŠ¨å¤„ç†é™¤é›¶æƒ…å†µï¼Œè¿”å›NaN
### ç­–ç•¥åˆ‡æ¢ç±»

#### StockBondSwitch (è‚¡å€ºåˆ‡æ¢)

> **âš ï¸ å…¨å±€ä¸Šä¸‹æ–‡ä¿¡å·åŸè¯­**
>
> è¿™æ˜¯ä¸€ä¸ªéœ€è¦å…¨å±€ä¸Šä¸‹æ–‡çš„ç‰¹æ®Šä¿¡å·åŸè¯­ï¼Œå®ƒé€šè¿‡è°ƒç”¨æ ˆæ£€æµ‹å½“å‰æ­£åœ¨è¯„ä¼°çš„æ ‡çš„ç¬¦å·ï¼Œ
> å¹¶æ ¹æ®æ ‡çš„åœ¨æŠ•èµ„ç»„åˆä¸­çš„ä½ç½®ï¼ˆçº¦å®šï¼šç¬¬ä¸€ä¸ª=è‚¡ç¥¨ETFï¼Œç¬¬äºŒä¸ª=å€ºåˆ¸ETFï¼‰ä»¥åŠå¸‚åœºæ¡ä»¶
> è¿”å›ç›¸åº”çš„å¸ƒå°”ä¹°å…¥ä¿¡å·ã€‚è¯¥åŸè¯­å¯ç”¨äº† `REQUIRES_GLOBAL_CONTEXT = True` æ ‡å¿—ã€‚

æ ¹æ®å¸‚åœºæ¡ä»¶ä¿¡å·ä¸ºä¸åŒèµ„äº§ç”Ÿæˆäº’è¡¥çš„ä¹°å…¥ä¿¡å·ï¼Œå®ç°è‚¡å€ºè½®åŠ¨ç­–ç•¥ã€‚

```json
{
  "id": "stock_bond_buy",
  "type": "StockBondSwitch",
  "params": {
    "default_to_stock": true
  },
  "inputs": [
    { "ref": "market_trend_up" }
  ]
}
```

**å·¥ä½œåŸç†**:

è¯¥åŸè¯­é€šè¿‡æ£€æŸ¥è°ƒç”¨æ ˆè·å–ä»¥ä¸‹ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼š
- **å½“å‰æ ‡çš„**: ä» `SignalEvaluator` çš„ `_evaluated_components` ä¸­è·å–æ­£åœ¨è¯„ä¼°çš„æ ‡çš„ç¬¦å·
- **æ ‡çš„æ± **: ä» `CompositeStrategy` çš„ `all_symbols` ä¸­è·å–å®Œæ•´çš„æ ‡çš„åˆ—è¡¨

æ ¹æ®è·å–çš„ä¸Šä¸‹æ–‡å’Œä½ç½®çº¦å®šï¼Œä¸ºä¸åŒæ ‡çš„è¿”å›äº’è¡¥çš„å¸ƒå°”ä¿¡å·ï¼š

| æ¡ä»¶ä¿¡å· | è‚¡ç¥¨ETF(ä½ç½®0) | å€ºåˆ¸ETF(ä½ç½®1) |
|----------|----------------|----------------|
| `True`   | `True` (ä¹°å…¥)  | `False` (ä¸ä¹°) |
| `False`  | `False` (ä¸ä¹°) | `True` (ä¹°å…¥)  |

**é…ç½®çº¦å®š**:
- **symbols[0]**: è‚¡ç¥¨ETFï¼ˆå¦‚510300ã€SPYç­‰ï¼‰
- **symbols[1]**: å€ºåˆ¸ETFï¼ˆå¦‚511260ã€TLTç­‰ï¼‰

**å‚æ•°**:
- `default_to_stock`: å½“æ¡ä»¶ä¿¡å·ä¸­åŒ…å«NaNå€¼æ—¶çš„é»˜è®¤å¡«å……è¡Œä¸ºï¼ˆé»˜è®¤: trueï¼‰
  - `true`: NaNå¡«å……ä¸ºTrueï¼ˆåå‘è‚¡ç¥¨ï¼‰
  - `false`: NaNå¡«å……ä¸ºFalseï¼ˆåå‘å€ºåˆ¸ï¼‰

**è¿”å›å€¼**:
- è¿”å›å¸ƒå°”å‹ `pd.Series`ï¼Œè¡¨ç¤ºå½“å‰æ ‡çš„æ˜¯å¦åº”è¯¥ä¹°å…¥
- å¯¹äºè‚¡ç¥¨ETFï¼šæ¡ä»¶ä¸ºTrueæ—¶è¿”å›Trueï¼Œæ¡ä»¶ä¸ºFalseæ—¶è¿”å›False
- å¯¹äºå€ºåˆ¸ETFï¼šæ¡ä»¶ä¸ºFalseæ—¶è¿”å›Trueï¼Œæ¡ä»¶ä¸ºTrueæ—¶è¿”å›False

**å®Œæ•´é…ç½®ç¤ºä¾‹**:

```json
{
  "name": "è‚¡å€ºè½®åŠ¨ç­–ç•¥",
  "symbols": [
    {"symbol": "510300", "name": "æ²ªæ·±300ETF"},      // ä½ç½®0: è‚¡ç¥¨ETF
    {"symbol": "511260", "name": "10å¹´æœŸå›½å€ºETF"}    // ä½ç½®1: å€ºåˆ¸ETF
  ],
  "strategy_definition": {
    "market_indicators": {
      "indicators": [{"code": "000300.SH"}],
      "transformers": [
        {
          "name": "hs300_raw",
          "type": "IdentityTransformer",
          "params": {
            "indicator": "000300.SH",
            "field": "Close"
          }
        },
        {
          "name": "hs300_ma200",
          "type": "MovingAverageTransformer",
          "params": {
            "indicator": "000300.SH",
            "window": 200,
            "method": "simple",
            "field": "Close"
          }
        }
      ]
    },
    "trade_strategy": {
      "indicators": [],
      "signals": [
        {
          "id": "market_trend_up",
          "type": "GreaterThan",
          "inputs": [
            {"market": "000300.SH", "transformer": "hs300_raw"},
            {"market": "000300.SH", "transformer": "hs300_ma200"}
          ]
        },
        {
          "id": "stock_bond_buy",
          "type": "StockBondSwitch",
          "params": {
            "default_to_stock": true
          },
          "inputs": [
            {"ref": "market_trend_up"}
          ]
        },
        {
          "id": "stock_bond_sell",
          "type": "Not",
          "inputs": [
            {"ref": "stock_bond_buy"}
          ]
        }
      ],
      "outputs": {
        "buy_signal": "stock_bond_buy",
        "sell_signal": "stock_bond_sell"
      }
    }
  }
}
```

**å®ç°ç»†èŠ‚**:

1. **å…¨å±€ä¸Šä¸‹æ–‡æ£€æµ‹**: ä½¿ç”¨ `REQUIRES_GLOBAL_CONTEXT = True` æ ‡å¿—ï¼Œç¡®ä¿ `CompositeStrategy` åœ¨ `needs_global_data` æ¨¡å¼ä¸‹è¿è¡Œ

2. **è°ƒç”¨æ ˆæ£€æŸ¥**: é€šè¿‡ `inspect` æ¨¡å—éå†è°ƒç”¨æ ˆï¼Œä»ä¸åŒçš„frameä¸­è·å–ï¼š
   - `SignalEvaluator._evaluated_components['_symbol']`: å½“å‰è¯„ä¼°çš„æ ‡çš„
   - `CompositeStrategy.all_symbols`: å®Œæ•´çš„æ ‡çš„åˆ—è¡¨

3. **é”™è¯¯å¤„ç†**: 
   - æ— æ³•è·å–ä¸Šä¸‹æ–‡æ—¶è¿”å›å…¨False
   - æ ‡çš„æ± å°‘äº2ä¸ªæ—¶è¿”å›å…¨False  
   - å½“å‰æ ‡çš„ä¸åœ¨å‰ä¸¤ä¸ªä½ç½®æ—¶è¿”å›å…¨False

**æ³¨æ„äº‹é¡¹**:

- è¿™æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ä¿¡å·åŸè¯­ï¼Œè¿”å›å¸ƒå°”å‹Seriesï¼Œä¸å…¶ä»–ä¿¡å·åŸè¯­å®Œå…¨å…¼å®¹
- å¿…é¡»é…åˆ `CompositeStrategy` ä½¿ç”¨ï¼Œä¸èƒ½ç”¨äºå•æ ‡çš„ç­–ç•¥
- å–å‡ºä¿¡å·é€šå¸¸ä½¿ç”¨ `Not` åŸè¯­å¯¹ä¹°å…¥ä¿¡å·å–å
- é€‚ç”¨äºä»»ä½•ä¸¤èµ„äº§è½®åŠ¨ç­–ç•¥ï¼ˆä¸ä»…é™äºè‚¡å€ºï¼‰

**ä½¿ç”¨åœºæ™¯**:
- è‚¡å€ºè½®åŠ¨ï¼ˆè‚¡ç¥¨ETF â†” å€ºåˆ¸ETFï¼‰
- é£é™©å¼€å…³ç­–ç•¥ï¼ˆé£é™©èµ„äº§ â†” é¿é™©èµ„äº§ï¼‰  
- è¶‹åŠ¿è·Ÿè¸ªï¼ˆè¶‹åŠ¿èµ„äº§ â†” ç°é‡‘ç­‰ä»·ç‰©ï¼‰
- åŠ¨é‡è½®åŠ¨ï¼ˆé«˜åŠ¨é‡èµ„äº§ â†” ä½åŠ¨é‡èµ„äº§ï¼‰

## ä¿¡å·ç»„åˆæœ€ä½³å®è·µ

1. **æ„å»ºå¤åˆæ¡ä»¶**:
   - ä½¿ç”¨`And`ã€`Or`ç»„åˆå¤šä¸ªä¿¡å·
   - ä½¿ç”¨`Not`åè½¬ä¿¡å·
   - ä¾‹å¦‚: `And(CrossAbove(RSI, 30), GreaterThan(Close, SMA))`

2. **äº¤å‰äº‹ä»¶vsçŠ¶æ€**:
   - äº¤å‰äº‹ä»¶(CrossAbove/CrossBelow)åªåœ¨ç©¿è¶Šå‘ç”Ÿæ—¶ä¸ºtrue
   - çŠ¶æ€æ¯”è¾ƒ(GreaterThan/LessThan)åªè¦æ¡ä»¶æ»¡è¶³å°±ä¸€ç›´ä¸ºtrue
   - æ˜ç¡®äº†è§£è¿™ä¸€åŒºåˆ«å¯¹é¿å…é¢‘ç¹äº¤æ˜“å¾ˆé‡è¦

3. **è¿‡æ»¤å‡ä¿¡å·**:
   - ä½¿ç”¨Streakè¦æ±‚ä¿¡å·æŒç»­ä¸€å®šæ—¶é—´
   - ç»“åˆå¤šä¸ªæŒ‡æ ‡ç¡®è®¤ä¿¡å·
   - ä½¿ç”¨è¶‹åŠ¿è¿‡æ»¤å™¨(å¦‚ä»·æ ¼é«˜äºå‡çº¿)

4. **ä¿¡å·å‘½åå’Œç»„ç»‡**:
   - ä½¿ç”¨æ¸…æ™°çš„IDå‘½åæ¯ä¸ªä¿¡å·ç»„ä»¶
   - ä»ç®€å•åˆ°å¤æ‚é€æ­¥æ„å»ºä¿¡å·
   - å…ˆå®šä¹‰åŸºæœ¬æ¡ä»¶ï¼Œå†ç»„åˆæˆå¤æ‚æ¡ä»¶

## å¸¸è§é”™è¯¯å’Œè§£å†³æ–¹æ¡ˆ

1. **è¿‡åº¦é¢‘ç¹çš„ä¿¡å·**:
   - é—®é¢˜: ä½¿ç”¨çŠ¶æ€æ¯”è¾ƒ(å¦‚GreaterThan)ä½œä¸ºä¹°å…¥ä¿¡å·
   - è§£å†³: ä½¿ç”¨CrossAbove/CrossBelowæ£€æµ‹äº¤å‰äº‹ä»¶

2. **ä¿¡å·ç¼ºå¤±**:
   - é—®é¢˜: è¾“å…¥æ—¶é—´åºåˆ—æœ‰NaNå€¼
   - è§£å†³: ç¡®ä¿æŒ‡æ ‡è®¡ç®—æœ‰è¶³å¤Ÿçš„å†å²æ•°æ®

3. **ç²¾åº¦é—®é¢˜**:
   - é—®é¢˜: æµ®ç‚¹æ¯”è¾ƒå¯¼è‡´ä¸ç¨³å®šçš„ç»“æœ
   - è§£å†³: åœ¨Comparisonä¸­ä½¿ç”¨epsilonå‚æ•°

4. **é€»è¾‘é”™è¯¯**:
   - é—®é¢˜: æ··æ·†And/Oré€»è¾‘
   - è§£å†³: ä»”ç»†éªŒè¯å¤åˆæ¡ä»¶çš„é¢„æœŸè¡Œä¸º
